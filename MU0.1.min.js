"use strict";let __onload,__way="./",__mode="def",__groups=[],__snippets=[],__patterns=[],__compression="normal";export const nodeMap=class{constructor(a){if(this.finale=[],0!==a.children.length)for(let b=0;b<a.children.length;b++)this.getThen(a.children[b],0);return this.finale}getThen(a,b){if("script"!==a.localName&&"style"!==a.localName){this.finale.push({body:a,lvl:b+1});let c=a.children||"noC";if("noC"!==c)for(let c=0;c<a.children.length;c++)this.getThen(a.children[c],b+1)}}};const fixWay=(a,b)=>void 0===a?(log.error("wrong default way"),b):"./"===a.slice(0,2)&&"/"===a.slice(-1)?a:void 0,fixMode=(a,b)=>"get"===a||"def"===a?a:(log.error("wrong default mode(it can be only \"def\" of \"get\")"),b),fixGroups=a=>{let b=[];for(let c in a)"./"===a[c].slice(0,2)&&"/"===a[c].slice(-1)?b[c]=a[c]:log.error("Wrong way in group '"+c+"'");return b},fixSnippets=a=>{let b=[];if(a==null)return[];for(let c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},fixPatterns=a=>{let b=[];if(a==null)return[];for(let c in a)a.hasOwnProperty(c)&&(("./"===a[c].slice(0,2)||"../"===a[c].slice(0,3))&&".mu"===a[c].slice(-3)?b[c]=a[c]:log.error("wrong way on pattern "+c));return b},getAim=(a,b)=>{let c,d=document.getElementsByTagName("MU:"+a);for(let e=0;e<d.length;e++)d[e].getAttribute("group")==b&&(c=d[e],e=d.length);return c},getScript=a=>{let b=document.createElement("script"),c=a.getElementsByTagName("script")[0]||"noScript";return"noScript"==c?c:(b.innerHTML=getParsedJS(c.textContent),b)},getParsedJS=a=>insertSnippets(a),getCommonStyle=(a,b)=>a.selectorText+"[data-mu-name = \""+b+"\"]{"+a.cssText.split("{")[1],getMediaScoped=(a,b)=>{let c="@media "+a.conditionText+"{";for(let d in a.cssRules)a.cssRules.hasOwnProperty(d)&&(c+=getCommonStyle(a.cssRules[d],b));return c+"}"},getScopedAll=({block:a,style:b,name:c,group:d})=>{let e=c+(void 0===d?"":"_"+d),f="",g=b.sheet.cssRules,h=new nodeMap(a);for(let i in a.dataset.muName=e,h.forEach(a=>{"mu:"==a.body.localName.slice(0,3)?"":a.body.dataset.muName=e}),g)g.hasOwnProperty(i)&&(f+=(void 0===g[i].selectorText?"":getCommonStyle(g[i],e))+(void 0===g[i].name?"":g[i].cssText)+(void 0===g[i].conditionText?"":getMediaScoped(g[i],e))+(void 0===g[i].href?"":g[i].cssText)+("@font-face"==g[i].cssText.slice(0,10)?g[i].cssText:""));return b.innerHTML=f,[a,b]},getTextAim=({name:a,group:b,state:c})=>{let d=new RegExp("<mu:"+a+(b===void 0?"":".+group.+\""+b+"\"")+".*>(.|\n)*?</mu:"+a+">","g");return c.match(d)!==void 0&&null!==c.match(d)?c.match(d)[0]:void 0},getExtendedComp=(a,b,c)=>{if(!c)return b;let d=b.slice(0);for(let e in a)if(a.hasOwnProperty(e)){let b=new RegExp("#"+e,"g");d=d.replace(b,a[e])}return d},insertSnippets=a=>{for(let b in __snippets)if(__snippets.hasOwnProperty(b)){let c=new RegExp("!"+b+"!","g");a=a.replace(c,__snippets[b])}return a},fixOnload=a=>{if(null==a)return a;if("string"!=typeof a||""==a)return log.error("Wrong onload param"),a;let b=document.createElement("script");return b.innerHTML=a,b},fixCompression=(a,b)=>void 0===a?b:"string"==typeof a?"normal"===a||"none"===a?a:(log.error("Wrong compression type "+a),b):(log.error("invalid compression value type"),b),log={messages:[],error(a){let b=document.createElement("div");b.style.color="#D62C2C",b.style.fontFamily="inherit",b.style.fontSize="1.5rem",b.innerHTML="ERROR: "+a,this.messages.push(b)},message(a){let b=document.createElement("div");b.style.color="#4E74D3",b.style.fontFamily="inherit",b.style.fontSize="1.5rem",b.innerHTML="Message: "+a,this.messages.push(b)},show(){if(0==this.messages.length)return;let a=document.createElement("div"),b=document.createElement("div");a.style="width:100vw; height: 100vh; background: rgba(0,0,0,.8); position: fixed; top: 0; left: 0; color: white; font-family: Calibri; overflow-y: scroll",b.style="width: 100%; text-align: center; background: #E62121; font-size: 2rem; font-family:inherit; cursor: pointer;box-shadow:0px 3px 0px 0px #B62929",b.innerHTML="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",b.onclick=function(){this.parentElement.remove()},a.appendChild(b),this.messages.forEach(b=>{a.appendChild(b)}),document.body.appendChild(a)},code(a){this.message("Compiled!<hr>");let b=document.createElement("div");b.style.color="#F3F3F3",b.style.fontFamily="inherit",b.style.fontSize="1rem",b.innerText=a,this.messages.push(b)}};export const parse=async function(a){if("string"==typeof a){if("./"!==a.slice(0,2)||".json"!==a.slice(-5))return void log.error("Wrong way to json file");await fetch(a).then(a=>a.json(),a=>console.error("there is problem: "+a)).then(b=>{a=b})}"object"==typeof a&&(__way=fixWay(a.way,__way),__mode=fixMode(a.mode,__mode),__groups=fixGroups(a.groups),__snippets=fixSnippets(a.snippets),__onload=fixOnload(a.onload),__patterns=fixPatterns(a.patterns),__compression=fixCompression(a.compression,__compression));let b=[],c=[];new nodeMap(document.body).forEach(a=>{b.push(getMUcomponent(a.body,a.lvl))}),b.forEach(a=>{getFetch(a,c,b.length)})};function activeParse(a){let b,c=[];a.forEach(a=>{if("error"!==a){let d={};for(let c in b<a.lvl||null==b?b=a.lvl:"",a)d[c]=a[c];c.push(d)}}),c.forEach(a=>{a.body=compileObject(a.body,a.name,a.group)}),"get"===__mode&&textOutput({coms:c,state:document.body.outerHTML,max:b}),insertInDOM(c,b),__onload===void 0?"":document.body.appendChild(__onload),log.show()}function insertInDOM(a,b){for(let c,d=1;d<=b;d++)c=[],a.forEach(a=>{a.lvl==d&&c.push(a)}),c.forEach(a=>{let b=getAim(a.name,a.group);null==b||(b.parentElement.insertBefore(a.body,b),b.remove())})}function compileObject(a,b,c){let d=document.createElement("div");d.style.display="none",d.innerHTML=a,document.body.appendChild(d);let e,f=d.getElementsByTagName("style")[0]||"noStyle",g=getScript(d);for(let f=0;f<d.children.length;f++)"style"!==d.children[f].localName&&"script"!==d.children[f].localName&&(e=d.children[f],f=d.children.length);return"noStyle"!==f&&null!==f.getAttribute("scoped")&&([e,f]=getScopedAll({block:e,style:f,name:b,group:c}),f.removeAttribute("scoped")),"noStyle"===f?"":e.appendChild(f),"noScript"!==g&&""!=g.innerHTML.replace(/\n/g,"")?e.appendChild(g):"",d.remove(),e}function getMUcomponent(a,b){return-1===a.localName.search(/mu:/)?void 0:{name:a.localName.slice(3),nodeLvl:b,way:null===a.getAttribute("way")?"noWay":a.getAttribute("way"),group:null===a.getAttribute("group")?"noGroup":a.getAttribute("group"),extends:null===a.getAttribute("extends")?"noExtends":{name:a.getAttribute("extends"),data:a.getAttribute("MUdata")}}}async function getFetch(a,b,c){let d,e=__way+a.name+".mu",f=!0;"noExtends"!==a.extends&&"self"!==a.extends.name?__patterns[a.extends.name]===void 0?(log.error("Unknown group on component \""+a.name+"\""),f=!1):e=__patterns[a.extends.name]:"noGroup"===a.group?"noWay"!==a.way&&(e=a.way):e=__groups[a.group]===void 0?e:__groups[a.group]+a.name+".mu",await fetch(e).then(a=>!0==a.ok?a.text():"error",a=>console.error(a)).then(b=>{"error"===b?d="error":(d={name:a.name,body:"noExtends"===a.extends?b:getExtendedComp(JSON.parse(a.extends.data),b,f),lvl:a.nodeLvl},"noGroup"===a.group?"":d.group=a.group,"noExtends"!==a.extends&&!0==f?d.extends=a.extends:"")}),b.push(d),b.length==c&&activeParse(b)}function textOutput({coms:a,state:b,max:c}){for(let d,e=1;e<=c;e++)d=[],a.forEach(a=>{a.lvl==e&&d.push(a)}),d.forEach(a=>{let c=new RegExp(getTextAim({name:a.name,group:a.group,state:b}));null==c||(void 0===c?"":b=b.replace(c,a.body.outerHTML))});b=b.replace(/<script type="module"(.|\n)*?<\/script>/g,""),"normal"==__compression&&(b=b.replace(/\n/g,""),b=b.replace(/<!--.+-->/g,""),b=b.replace(/>\s</g,"><")),__onload===void 0?"":b=b.replace(/<body/,"<body onload = \""+__onload.innerHTML+"\""),log.code(b)}